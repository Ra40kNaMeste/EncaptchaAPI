# EncaptchaAPI - это клон API с rucaptcha
## Анотация
Данное API было написано в качестве тестового задания. Данное API копирует логику взаимодействия rucaptcha API, однако не повторяет её точь в точь.
## Отличия
* Необходимость авторизации через header и jwt-токен, на не через 32-х знаковый код, передающийся в теле запроса. Это сделано для ускорения разработки и большей безопасности системы
## Запуск API
### Настройка ip-адреса
* Передите в консоль от имени адинистратора и выполните команду 
```
ipconfig
```
* Найдите ip4-адрес адаптера Ethernet vEthernet (WSL)
* Запишите его в переменную  в [docker-compose.override.yml файле](docker-compose.override.yml) V_ADAPTER_I
* Также запишите его в строку запроса к БД в [конфигурации](./EncaptchaAPI/appsettings.json) проекта ("UserDb": "Server=ваш_ip,1433...")

* Необходимо установить [Docker](https://www.docker.com)
* Перейдя в корневой каталог проекта необходимо выполнить следующую команду из командной строки
```
docker compose up -d
```
После чего будет выполнена компиляция debug-версии проекта. Изменить версию можно через Visual Studio, открыв проект там.
* Альтернативно можно запустить проект в Visual Studion использую docker-compose
* По ссылке https://localhost:8081/swagger/index.html можно ознакомиться с API проекта через интерфейс swagger
* После запуска контейнера tests произойдёт выполнение всех unit-тестов API и вывод результата тестирования в консоль контейнера. Его необходимо запускать после запуска сревера. Запуск контейнера тестов осуществлять только с пустой БД! Если некоторые тесты на одном баузере не прошли, но прошли на других, то перезапустите контейнер. Это связано с генерацией имён данных базы данных
## Гайд по API
Для выполнения гайдов рекомендуется использовать интерфейс swagger'а: https://localhost:8081/swagger/index.html
### Пользователи
Пользователи имеют свои типы: SuperAdmin(3), Admin(2), Customer(1) и Employeer(0). 
Добавление обычного пользователя Customer и Employeer осуществляется путём Get-запроса по адресу https://localhost:8081/registration (post). В качестве параметров поисковой строки необходимо передать Email, Password и Title пользователя, причём Title - значение роли 0, если исполнитель, и 1, если заказчик. В ответ сервер пришлёт jwt-токен зарегистрируемого пользователи или ошибку
Если пользователь был добавлен, то войти в него аккаунт можно по запросу на адрес https://localhost:8081/login (post) с параметрами строки запроса Email и Password. В случае успешного входа сервер также вернёт jwt-токен
Jwt-токен необходимо отправлять каждый раз в header'е Authorization в виде строки "Bearer ваш_jwt_токен". Например, если токен будет fds23g1, то строка будет "Bearer fds23g1". Последующие запросы будут обрабатываться только с jwt-токеном

Получение пользователя: https://localhost:8081/user (get)
Удаление пользователя: https://localhost:8081/user (delete)
Изменение роли пользователя: https://localhost:8081/user (put). Параметр адресной строки - role - численное значение роли. Поменять можно только на Customer или Employeer
Получение информации о всех пользователей (можно без авторизации): https://localhost:8081/users (get)

Для администрации есть возможность удаление пользователя по id: https://localhost:8081/user/{id} (delete) и изменение его роли: https://localhost:8081/user/{id} (put) с параметром role

### Алгоритм использования сайта для решения API
#### Для заказчика
* Отправить капчу на сайт: https://localhost:8081/captures (post). В теле запроса необходимо установить форму с элементом с именем file и значением - файлом капчи. В ответном письме будет лежать id капчи. В заголовках не забывать указывать jwt-токен для авторизации
* Подождать её решения
* Направить запрос на сайт:  https://localhost:8081/captcha/{id} (get). Если капча была решена, то придёт ответ с решением в теле. Иначе - ошибка
* Также можно удалить отправленную капчу через https://localhost:8081/captcha/{id} (delete)
### Для исполнителя
* Отправить запрос на сайт: https://localhost:8081/emp/captcha (get). Если есть нерешённая капча, то придёт ответ с Id этой капчей. Капча будет с этого времени закреплена а вами. Если необходимо отказаться от выполнения, то надо направить запрос на https://localhost:8081/emp/captcha/{id} (delete)
* Изображение капчи лежит по адресу https://localhost:8081/emp/captcha/{id} (get)
* После расшифровки ответ записать в https://localhost:8081/emp/captcha/{id} (post) с параметром строки result=ответ

### Администрирование
Создать администратора можно через https://localhost:8081/registration/super/secret/path (post) с такимиже параметрами, что и для регистрации пользователя + параметр строки запроса secretKey - секретный ключ, который хранится в [конфигурации](./EncaptchaAPI/appsettings.json) проекта (Authorization/KeyForAdminRegistration) и [переменных окружения](docker-compose.override.yml) для контейнера tests
Для администрации доступны следующие функции: 
* Изменение роли пользователя на роль, меньшую по приоритету изменяющего: https://localhost:8081/user/{id} (post) с параметром строки role
* Просмотр всех капч: https://localhost:8081/captures (get)